<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Town of Antigonish Capital Projects Timeline</title>
    <script src="https://cdn.anychart.com/releases/8.11.0/js/anychart-core.min.js"></script>
    <script src="https://cdn.anychart.com/releases/8.11.0/js/anychart-timeline.min.js"></script>
    <script src="https://cdn.anychart.com/releases/8.11.0/js/anychart-ui.min.js"></script>
    <link rel="stylesheet" href="https://cdn.anychart.com/releases/8.11.0/css/anychart-ui.min.css">
    <style>
        html, body, #container {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
        }
    </style>
</head>
<body>

    <div id="container"></div>

    <script>
        anychart.onDocumentReady(function () {
            fetch('town_projects.json')
                .then(response => response.json())
                .then(data => {
                    // Create the chart
                    var chart = anychart.timeline();

                    // Function to create series for a project
                    function createProjectSeries(projectData, projectKey) {
                        // Color with opacity for ranges
                        // We can't easily parse hex here without a library, but AnyChart supports opacity in fill string or object
                        // Let's assume hex and use AnyChart's color helper or just simple hex if no opacity needed
                        // User requested opacity. Let's use anychart.color.lighten or set opacity.
                        var color = projectData.color;
                        var fill = anychart.color.setOpacity(color, 0.6);

                        // Range Series
                        var ranges = projectData.phases.map(p => ({
                            name: p.name,
                            start: new Date(p.start),
                            end: new Date(p.end),
                            fill: fill,
                            stroke: color,
                            description: p.description
                        }));
                        var rangeSeries = chart.range(ranges);
                        rangeSeries.name(projectData.title); // For Legend
                        // Set series fill/stroke to match project color so Legend picks it up
                        rangeSeries.fill(fill);
                        rangeSeries.stroke(color);

                        rangeSeries.labels().format("{%name}");
                        rangeSeries.labels().fontColor("#ffffff");
                        rangeSeries.tooltip().useHtml(true);

                        // Moment Series
                        var moments = projectData.events.map(e => ({
                            x: new Date(e.date),
                            y: e.name,
                            description: e.description
                        }));
                        var momentSeries = chart.moment(moments);
                        momentSeries.name(projectData.title + " Events"); // For Legend if needed, or hide
                        momentSeries.normal().markers().fill(color);
                        momentSeries.normal().markers().stroke(color);
                        momentSeries.direction("down");

                        // We might want to hide moment series from legend to avoid clutter?
                        // Or show them. The user said "label somewhere what the projects are".
                        // Legend items for "Bay Street Capital Project" (Range) is enough.
                        momentSeries.legendItem().enabled(false);

                        return { ranges, moments };
                    }

                    var allData = [];

                    // Bay Street
                    var bay = createProjectSeries(data.bayStreet, "bayStreet");
                    allData = allData.concat(bay.ranges.map(r => r.start), bay.ranges.map(r => r.end), bay.moments.map(m => m.x));

                    // West Street
                    var west = createProjectSeries(data.westStreet, "westStreet");
                    allData = allData.concat(west.ranges.map(r => r.start), west.ranges.map(r => r.end), west.moments.map(m => m.x));

                    // Active Trail
                    if (data.activeTrail) {
                        var trail = createProjectSeries(data.activeTrail, "activeTrail");
                        allData = allData.concat(trail.ranges.map(r => r.start), trail.ranges.map(r => r.end), trail.moments.map(m => m.x));
                    }

                    // --- Tooltips (Global format if not overridden) ---
                    chart.tooltip().useHtml(true);
                    chart.tooltip().format(function() {
                        var start = this.start ? anychart.format.dateTime(this.start, "dd MMM yyyy") : null;
                        var end = this.end ? anychart.format.dateTime(this.end, "dd MMM yyyy") : null;
                        var date = this.x ? anychart.format.dateTime(this.x, "dd MMM yyyy") : null;

                        var title = this.getData("name") || this.value;
                        var desc = this.getData("description");
                        var seriesName = this.seriesName;

                        var content = "<span style='font-weight:600;font-size:12pt'>" + title + "</span><br>";
                        content += "<span style='font-size:10pt; color: #888'>" + seriesName + "</span><br><br>";

                        if (start && end) {
                            content += "Dates: " + start + " - " + end + "<br>";
                        } else if (date) {
                            content += "Date: " + date + "<br>";
                        }

                        if (desc) {
                            content += desc;
                        }
                        return content;
                    });

                    // --- Scroller ---
                    chart.scroller().enabled(true);

                    // --- Legend ---
                    chart.legend().enabled(true);
                    chart.legend().fontSize(14);
                    chart.legend().padding(10);

                    // --- Markers ---
                    var todayMarker = chart.todayMarker();
                    todayMarker.stroke("#dd2c00", 2, "5 2");

                    // Year Markers
                    var minYear = new Date(Math.min.apply(null, allData)).getFullYear();
                    var maxYear = new Date(Math.max.apply(null, allData)).getFullYear();
                    maxYear = Math.max(maxYear, new Date().getFullYear());

                    var markerIndex = 0;
                    for (var y = minYear; y <= maxYear; y++) {
                        var lineMarker = chart.lineMarker(markerIndex);
                        lineMarker.value(new Date(y, 0, 1));
                        lineMarker.stroke("#555", 2, "5 2");

                        var textMarker = chart.textMarker(markerIndex);
                        textMarker.value(new Date(y, 0, 1));
                        textMarker.text(y.toString());
                        textMarker.fontSize(16);
                        textMarker.fontColor("#555");
                        textMarker.fontWeight("bold");
                        textMarker.anchor("left-top");
                        textMarker.padding(5);

                        markerIndex++;
                    }

                    // Title
                    chart.title("Town of Antigonish Capital Projects Timeline");

                    chart.container("container");
                    chart.draw();
                    chart.fit();
                })
                .catch(error => console.error('Error loading data:', error));
        });
    </script>

</body>
</html>
